[include mainsail.cfg]
[include stealthburner_leds.cfg]
[include SHT36V3.cfg]
[include homing.cfg]
[include GBB15.cfg]
[include macros.cfg]
[exclude_object]
[pause_resume]

#####################################################################
#      MCU
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_36004C000251323438323636-if00

[temperature_sensor Spider_(MCU)]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi_3B]
sensor_type: temperature_host
min_temp: 10
max_temp: 100 

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 2000			        #Vorher: 3000 Max 4000
max_z_velocity: 15			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 150
square_corner_velocity: 5.0

[force_move]
enable_force_move: true

#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
[stepper_z]
step_pin: PD14
dir_pin: PD13
enable_pin: !PD15
rotation_distance: 40
gear_ratio: 80:16
microsteps: 128
endstop_pin: probe:z_virtual_endstop
position_max: 310
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin: PD10
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 200

##	In E1-MOT Position
##	Z1 Stepper - Rear Left
[stepper_z1]
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 128

[tmc2209 stepper_z1]
uart_pin: PC14
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 200

##	In E2-MOT Position
##	Z2 Stepper - Rear Right
[stepper_z2]
step_pin: PE2
dir_pin: PE4
enable_pin: !PE3
rotation_distance: 40
gear_ratio: 80:16
microsteps: 128

[tmc2209 stepper_z2]
uart_pin: PC15
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 200

##	In E3-MOT Position
##	Z3 Stepper - Front Right (TMC2209 am 05.01.2024 getauscht nach 'stepper_z3' register IFCNT Fehler)
## Wechsel von M6 zu M3
[stepper_z3]
step_pin: PD5
dir_pin: !PD6
enable_pin: !PD4
rotation_distance: 40
gear_ratio: 80:16
microsteps: 128

[tmc2209 stepper_z3]
uart_pin: PD7
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 200

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
heater_pin: PB4
pwm_cycle_time: 0.02 #1s/50Hz=0.02
sensor_type: Generic 3950
sensor_pin: PB0
max_power: 0.55  ##	Adjust Max Power so your heater doesn't warp your bed
min_temp: 0
max_temp: 115

#####################################################################
#	Fan Control
#####################################################################

#see bigtreetech-ebb-sb-rp2040-canbus-v1.0.cfg

[controller_fan controller_fan]
##	Controller fan - FAN2 Connector
pin: PB2
stepper: stepper_x,stepper_y,stepper_z
fan_speed: 1.0
idle_timeout: 180
idle_speed: 1.0

[controller_fan controller_RPi]
##	Controller fan - FAN1 Connector
pin: PA14
stepper: stepper_x,stepper_y,stepper_z
fan_speed: 1.0
idle_timeout: 180
idle_speed: 1.0


[heater_fan exhaust_fan]
##  Exhaust fan - In E2 OUT Positon
pin: PB3
max_power: 1.0
shutdown_speed: 0.0
#kick_start_time: 0.5
heater: heater_bed
heater_temp: 60
fan_speed: 1.0

[heater_fan airfilter]
##  Airfilter Fan5 connector
pin: PB7
max_power: 1.0
shutdown_speed: 0.0
#kick_start_time: 0.5
heater: heater_bed
heater_temp: 50
fan_speed: 1.0

#####################################################################
#	LED Control
#####################################################################

[output_pin caselight ]
##  Chamber Lighting - In E1 OUT Position
pin: PC8
pwm: true
shutdown_value: 0
cycle_time: 0.01
value: 0.1

#####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 3600
gcode:
  M84
  TURN_OFF_HEATERS
  UPDATE_DELAYED_GCODE ID=delayed_printer_off DURATION=5
   
[quad_gantry_level]
gantry_corners:
	-60,-10
	410,420
	
##	Probe points
points:
	50,25
	50,275
	300,275
	300,25

speed: 200 #100
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.0075
#retry_tolerance: 0.075
max_adjust: 10

#####################################################################
#	Input Shaper
#####################################################################

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 49.2
shaper_type_y = ei
shaper_freq_y = 47.8

#####################################################################
#	KlipperScreen
#####################################################################

[virtual_sdcard]
path: ~/printer_data/gcodes
[display_status]
[pause_resume]

[gcode_macro _LDC_CALIBRATE_DRIVE_CURRENT]
gcode:
    BED_MESH_CLEAR
    SET_KINEMATIC_POSITION x=100 y=100 z=200
    G28 X Y
    M104 S0
    M140 S0
    M106 S0
    G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} F6000
    G0 Z30 F600
    G4 P1000
    LDC_CALIBRATE_DRIVE_CURRENT CHIP=fly_eddy_probe 
    G4 P1000
    SAVE_CONFIG

[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
    BED_MESH_CLEAR
    G28 X Y
    M104 S0
    M140 S0
    M106 S0
    G90 # Abs positioning
    G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
    {% if 'z' not in printer.toolhead.homed_axes %}
        SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
    {% endif %}
    PROBE_EDDY_CURRENT_CALIBRATE {rawparams}

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
    #175, 175, 20  # an example

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 40.658
#*# pid_ki = 1.772
#*# pid_kd = 233.276
#*#
#*# [extruder]
#*#
#*# [stepper_z]
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.103015, 0.119421, 0.131389, 0.131515, 0.085959
#*# 	0.075491, 0.085363, 0.091579, 0.092355, 0.070591
#*# 	0.065825, 0.136460, 0.048143, 0.063846, 0.069632
#*# 	0.086133, 0.061694, 0.054350, 0.067570, 0.077136
#*# 	0.122561, 0.085714, 0.087691, 0.102251, 0.121625
#*# tension = 0.2
#*# min_x = 40.0
#*# algo = lagrange
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 40.0
#*# x_count = 5
#*# max_y = 310.0
#*# mesh_x_pps = 2
#*# max_x = 310.0
#*#
#*# [probe]
#*# z_offset = -1.700
#*#
#*# [probe_eddy_current fly_eddy_probe]
#*# reg_drive_current = 19
#*# calibrate =
#*# 	0.350000:1385918.119,0.390000:1383794.879,0.430000:1381609.014,
#*# 	0.470000:1379469.695,0.510000:1377367.115,0.550000:1375218.987,
#*# 	0.590000:1373136.204,0.630000:1371110.800,0.670000:1369138.261,
#*# 	0.710000:1367183.007,0.750000:1365262.946,0.790000:1363419.313,
#*# 	0.830000:1361603.270,0.870000:1359770.359,0.910000:1357989.787,
#*# 	0.950000:1356284.743,0.990000:1354602.771,1.030000:1352937.897,
#*# 	1.070000:1351304.923,1.110000:1349723.446,1.150000:1348165.975,
#*# 	1.190000:1346630.645,1.230000:1345083.012,1.270000:1343650.703,
#*# 	1.310000:1342236.952,1.350000:1340780.575,1.390000:1339425.047,
#*# 	1.430000:1338153.355,1.470000:1336773.362,1.510000:1335513.346,
#*# 	1.550000:1334205.281,1.590000:1332918.629,1.630000:1331747.602,
#*# 	1.670000:1330544.618,1.710000:1329369.722,1.750000:1328242.316,
#*# 	1.790000:1327116.685,1.830000:1326015.367,1.870000:1324941.637,
#*# 	1.910000:1323892.563,1.950000:1322851.894,1.990000:1321845.175,
#*# 	2.030000:1320842.836,2.070000:1319885.354,2.110000:1318946.832,
#*# 	2.150000:1317995.303,2.190000:1317088.439,2.230000:1316205.624,
#*# 	2.270000:1315325.646,2.310000:1314482.026,2.350000:1313608.859,
#*# 	2.390000:1312794.696,2.430000:1311989.357,2.470000:1311179.175,
#*# 	2.510000:1310393.591,2.550000:1309642.448,2.590000:1308900.967,
#*# 	2.630000:1308168.939,2.670000:1307431.208,2.710000:1306726.281,
#*# 	2.750000:1306036.397,2.790000:1305377.235,2.830000:1304698.069,
#*# 	2.870000:1304048.311,2.910000:1303402.771,2.950000:1302784.291,
#*# 	2.990000:1302148.036,3.030000:1301549.376,3.070000:1300969.902,
#*# 	3.110000:1300395.260,3.150000:1299815.516,3.190000:1299259.163,
#*# 	3.230000:1298710.649,3.270000:1298170.020,3.310000:1297632.251,
#*# 	3.350000:1297120.298,3.390000:1296595.100,3.430000:1296082.424,
#*# 	3.470000:1295612.106,3.510000:1295131.921,3.550000:1294639.372,
#*# 	3.590000:1294183.079,3.630000:1293756.260,3.670000:1293286.566,
#*# 	3.710000:1292854.546,3.750000:1292410.655,3.790000:1291973.353,
#*# 	3.830000:1291559.789,3.870000:1291115.037,3.910000:1290756.776,
#*# 	3.950000:1290342.504,3.990000:1289960.630,4.030000:1289575.267,
#*# 	4.070000:1289200.394,4.110000:1288817.244,4.150000:1288466.420,
#*# 	4.190000:1288113.175,4.230000:1287763.256,4.270000:1287411.318,
#*# 	4.310000:1287076.872,4.350000:1286739.486
#*#
#*# [temperature_probe fly_eddy_probe]
#*# calibration_temp = 21.311823
#*# drift_calibration =
#*# 	1395075.060682, -457.659609, 4.482722
#*# 	1367035.003429, -312.486819, 3.140630
#*# 	1345425.744066, -224.342895, 2.308969
#*# 	1328709.718436, -151.399928, 1.575846
#*# 	1316069.581357, -111.989571, 1.211886
#*# 	1306190.508650, -78.790740, 0.872021
#*# 	1298393.540692, -52.125741, 0.604407
#*# 	1292255.876698, -31.528831, 0.384150
#*# 	1287343.504503, -15.024908, 0.207354
#*# drift_calibration_min_temp = 21.843067574589863
